exports.ids=[31],exports.modules={174:function(e,t){},182:function(e,t,r){"use strict";r(88),r(2);var n=r(46),o={name:"VPopover",components:{"el-popover":r.n(n).a},props:{width:{type:Number,default:240},actions:{type:Array,default:()=>[]},reportType:{type:String,default:""},reportId:{type:[Number,String],default:0},reportText:{type:String,default:"举报"},isCreator:{type:Boolean,default:!1},className:{type:String,default:""}},data:()=>({show:!1,backdropId:0}),computed:{actionList(){const e=this.actions;return this.reportId&&e.push({name:this.reportText,method:()=>this.$channel.$emit("open-report-drawer",{id:this.reportId,model:this.reportType,title:this.reportText,isCreator:this.isCreator})}),e}},methods:{handleShow(){this.backdropId=this.$backdrop.show()},handleHide(){this.$backdrop.hide(this.backdropId)},handleClick(){this.show=!1}}},l=r(1);var component=Object(l.a)(o,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("span",{class:e.className},[r("el-popover",{attrs:{width:e.width,trigger:"click","popper-class":"v-popover"},on:{show:e.handleShow,hide:e.handleHide},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[r("ul",{on:{click:e.handleClick}},e._l(e.actionList,function(t,n){return r("li",{key:n,on:{click:t.method}},[r("i",{staticClass:"el-icon-arrow-right"}),e._v(" "),r("span",{staticClass:"oneline",domProps:{textContent:e._s(t.name)}})])}),0),e._v(" "),e._t("default",null,{slot:"reference"})],2)],1)},[],!1,function(e){var t=r(186);t.__inject__&&t.__inject__(e)},null,"9847f35e");t.a=component.exports},186:function(e,t,r){"use strict";r.r(t);var n=r(174),o=r.n(n);for(var l in n)"default"!==l&&function(e){r.d(t,e,function(){return n[e]})}(l);t.default=o.a},206:function(e,t){},219:function(e,t,r){"use strict";t.a={async fetch({store:e,error:t}){await e.dispatch("initAuth")||t({statusCode:"401",message:"继续操作前请先登录"})}}},288:function(e,t){},289:function(e,t){},290:function(e,t){},374:function(e,t){},375:function(e,t,r){"use strict";r.r(t);var n=r(288),o=r.n(n);for(var l in n)"default"!==l&&function(e){r.d(t,e,function(){return n[e]})}(l);t.default=o.a},376:function(e,t,r){"use strict";r.r(t);var n=r(289),o=r.n(n);for(var l in n)"default"!==l&&function(e){r.d(t,e,function(){return n[e]})}(l);t.default=o.a},377:function(e,t,r){"use strict";r.r(t);var n=r(290),o=r.n(n);for(var l in n)"default"!==l&&function(e){r.d(t,e,function(){return n[e]})}(l);t.default=o.a},428:function(e,t,r){"use strict";r.r(t);var n=r(162),o=r.n(n),l=(r(374),{name:"ImageCropper",components:{croppa:o.a.component},props:{width:{type:Number,default:200},height:{type:Number,default:200},autoSize:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},sizeLimit:{type:Number,default:0},initImage:{type:String,default:""},type:{type:String,default:"normal",validator:e=>~["avatar","normal"].indexOf(e)},uploading:{type:Boolean,default:!1}},data:()=>({croppa:{}}),methods:{onInit(){"avatar"===this.type&&this.croppa.addClipPlugin(function(e,t,r,n,o){e.beginPath(),e.arc(t+n/2,r+o/2,n/2,0,2*Math.PI,!0),e.closePath()})},async generateImage(){const e=await this.croppa.promisedBlob(),t=new FormData;t.append("file",e),this.$emit("submit",t)}}}),c=r(1);var d=Object(c.a)(l,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"image-cropper-wrap"},[r("croppa",{attrs:{width:e.width,height:e.height,"auto-sizing":e.autoSize,"show-remove-button":!1,"prevent-white-space":!0,disabled:e.disabled||e.uploading,"file-size-limit":e.sizeLimit,"zoom-speed":"avatar"===e.type?6:2,"initial-image":e.initImage,accept:"image/png, image/jpeg, image/jpg, image/x-png, image/gif","canvas-color":"rgba(0, 0, 0, .05)"},on:{init:e.onInit},model:{value:e.croppa,callback:function(t){e.croppa=t},expression:"croppa"}}),e._ssrNode(' <div class="tools"></div> '),r("el-button",{staticClass:"submit-btn",attrs:{loading:e.uploading,type:"warning",size:"mini",round:""},on:{click:e.generateImage}},[e._v("\n    确认\n  ")])],2)},[],!1,function(e){var t=r(375);t.__inject__&&t.__inject__(e)},null,"78f0c536").exports,h=(r(206),r(152)),m=r.n(h),v=r(182),f=r(3),_={name:"UserSettingForm",components:{VPopover:v.a,"mt-switch":m.a},data:()=>({beginTime:new Date((new Date).getFullYear()-40,0,1),endTime:new Date((new Date).getFullYear()-10,11,31),submitting:!1,sexMap:["点击选择","男","女","伪娘","药娘","扶她"],rule:{nickname:[{validator:(e,t,r)=>{const n=t.replace(/([\u4e00-\u9fa5])/g,"aa").trim().length;n?n<2?r(new Error("昵称至少为2个字符")):n>14&&r(new Error("昵称不能超过14个字符")):r(new Error("昵称不能为空")),r()},trigger:"submit"}],signature:[{validator:(e,t,r)=>{t.length>150&&r(new Error("签名最多 150 个字")),r()},trigger:"submit"}],birthday:[{validator:(e,t,r)=>{const n=t.getTime(),o=Date.now();n>=o?r(new Error("。。。")):o-n<31536e7?r(new Error("你应该大于10岁了吧...?")):o-n>15768e8&&r(new Error("你应该小于50岁的吧...?")),r()},trigger:"submit"}]}}),computed:{user(){return this.$store.state.user},sex(){return this.user.sex},nickname:{get(){return this.user.nickname},set(e){this.$store.commit("UPDATE_USER_INFO",{key:"nickname",value:e})}},birthday:{get(){return/-/.test(this.user.birthday)?new Date(this.user.birthday.replace(/-/g,"/")):new Date(this.user.birthday)},set(e){this.$store.commit("UPDATE_USER_INFO",{key:"birthday",value:e})}},birthSecret:{get(){return this.user.birthSecret},set(e){this.$store.commit("UPDATE_USER_INFO",{key:"birthSecret",value:e})}},sexSecret:{get(){return this.user.sexSecret},set(e){this.$store.commit("UPDATE_USER_INFO",{key:"sexSecret",value:e})}},signature:{get(){return this.user.signature},set(e){this.$store.commit("UPDATE_USER_INFO",{key:"signature",value:e})}},sexActions(){return[{name:this.sexMap[1],method:()=>{this.$store.commit("UPDATE_USER_INFO",{key:"sex",value:1})}},{name:this.sexMap[2],method:()=>{this.$store.commit("UPDATE_USER_INFO",{key:"sex",value:2})}},{name:this.sexMap[3],method:()=>{this.$store.commit("UPDATE_USER_INFO",{key:"sex",value:3})}},{name:this.sexMap[4],method:()=>{this.$store.commit("UPDATE_USER_INFO",{key:"sex",value:4})}},{name:this.sexMap[5],method:()=>{this.$store.commit("UPDATE_USER_INFO",{key:"sex",value:5})}}]},selectedSexLabel(){return this.sexMap[this.sex]},selectedBirthLabel(){const e=this.birthday;return/1970 08:00:00 GMT\+0800/.test(e)?"未设置":`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`}},methods:{openBirthPicker(){this.$refs.birthPicker.open()},submit(){this.$refs.form.validate(async e=>{if(!e)return!1;if(!this.submitting){this.submitting=!0;try{await Object(f.o)(this,{nickname:this.nickname,signature:this.signature,birthday:new Date(this.birthday).getTime()/1e3,birth_secret:this.birthSecret,sex_secret:this.sexSecret,sex:this.sex}),this.$toast.success("设置成功")}finally{this.submitting=!1}}})}}};var w=Object(c.a)(_,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("el-form",{ref:"form",staticClass:"user-setting-form",attrs:{disabled:e.submitting,model:e.user,rules:e.rule,"label-width":"50px"}},[r("div",{staticClass:"tips"},[r("p",[e._v("\n      填写正确的性别和生日有助于网站对你番剧喜好的分析，在未来我们有可能根据你的喜好来推荐合适的番剧\n    ")]),e._v(" "),r("p",[e._v("\n      如果你担心自己的性别和生日被其他用户知道，可以勾选"),r("strong",[e._v("私密")]),e._v("，这样我们只会在推荐系统中用到你的数据\n    ")])]),e._v(" "),r("el-form-item",{attrs:{label:"昵称",prop:"nickname"}},[r("el-input",{staticClass:"bottom-line",model:{value:e.nickname,callback:function(t){e.nickname=t},expression:"nickname"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"生日"}},[r("no-ssr",[r("mt-datetime-picker",{ref:"birthPicker",attrs:{"start-date":e.beginTime,"end-date":e.endTime,type:"date","year-format":"{value}年","month-format":"{value}月","date-format":"{value}日"},model:{value:e.birthday,callback:function(t){e.birthday=t},expression:"birthday"}})],1),e._v(" "),r("div",{staticClass:"state-wrap"},[r("div",{staticClass:"state-label"},[e._v("状态："+e._s(e.birthSecret?"私密":"公开"))]),e._v(" "),r("mt-switch",{model:{value:e.birthSecret,callback:function(t){e.birthSecret=t},expression:"birthSecret"}})],1),e._v(" "),r("div",{staticClass:"select-btn"},[r("button",{attrs:{type:"button"},domProps:{textContent:e._s(e.selectedBirthLabel)},on:{click:e.openBirthPicker}})])],1),e._v(" "),r("el-form-item",{attrs:{label:"性别"}},[r("div",{staticClass:"state-wrap"},[r("div",{staticClass:"state-label"},[e._v("状态："+e._s(e.sexSecret?"私密":"公开"))]),e._v(" "),r("mt-switch",{model:{value:e.sexSecret,callback:function(t){e.sexSecret=t},expression:"sexSecret"}})],1),e._v(" "),r("div",{staticClass:"select-btn"},[r("v-popover",{attrs:{actions:e.sexActions}},[r("button",{attrs:{type:"button"},domProps:{textContent:e._s(e.selectedSexLabel)}})])],1)]),e._v(" "),r("el-form-item",{attrs:{label:"签名",prop:"signature"}},[r("el-input",{staticClass:"bottom-line",attrs:{rows:5,type:"textarea",placeholder:"用简单的言语，表达深刻的心"},model:{value:e.signature,callback:function(t){e.signature=t},expression:"signature"}})],1),e._v(" "),r("el-button",{staticClass:"submit-btn",attrs:{loading:e.submitting,type:"primary",size:"small"},on:{click:e.submit}},[e._v("\n    提交\n  ")])],1)},[],!1,function(e){var t=r(376);t.__inject__&&t.__inject__(e)},null,"6b88dff5").exports,y=r(219),S=r(50),x={name:"UserSetting",components:{ImageCropper:d,UserSettingForm:w},mixins:[y.a],data:()=>({avatarSelector:{loading:!1,file:null,data:"",showDrawer:!1},bannerSelector:{loading:!1,file:null,data:""},bindPhone:{phone:"",password:"",authCode:"",timeout:0,showInfoForm:!1,loadingBindPhone:!1}}),computed:{user(){return this.$store.state.user},isMe(){return!!this.$store.state.login&&this.$route.params.zone===this.user.zone},ua(){return this.$store.state.ua}},methods:{selectAvatar(e){const t=e.target.files[0];if(!t)return void this.$toast.error("图片选择失败");if(-1===["image/jpeg","image/png","image/jpg","image/gif"].indexOf(t.type))return void this.$toast.error("仅支持 jpg / jpeg / png / gif 格式的图片");const r=new FileReader;this.avatarSelector.file=t,r.onload=(e=>{this.avatarSelector.data=e.target.result,this.avatarSelector.showDrawer=!0}),r.readAsDataURL(t)},cancelAvatarSelect(){this.avatarSelector.showDrawer=!1,this.avatarSelector.file=null,this.avatarSelector.data="",this.$nextTick(()=>{this.$refs.avatarInput.value=""})},async submitAvatarChange(e){if(this.avatarSelector.loading)return;this.$toast.loading("上传中..."),this.avatarSelector.loading=!0;const t=this.$utils.createFileName({userId:this.user.id,type:"avatar",file:this.avatarSelector.file});try{await this.$store.dispatch("getUpToken"),e.append("token",this.user.uptoken.upToken),e.append("key",t);const r=await Object(S.g)(this,e);await Object(f.n)(this,{type:"avatar",url:r.url}),this.$store.commit("SET_USER_INFO",{avatar:`https://image.calibur.tv/${r.url}`}),this.$toast.success("头像更新成功")}catch(e){"string"==typeof e?this.$toast.error(e):this.$toast.error("头像更新失败，请刷新网页重试或选择其他图片")}finally{this.avatarSelector.loading=!1,this.cancelAvatarSelect()}},selectBanner(e){const t=e.target.files[0];if(-1===["image/jpeg","image/png","image/jpg","image/gif"].indexOf(t.type))return void this.$toast.error("仅支持 jpg / jpeg / png / gif 格式的图片");const r=new FileReader;this.bannerSelector.file=t,r.onload=(e=>{this.bannerSelector.data=e.target.result}),r.readAsDataURL(t)},cancelBannerSelect(){this.bannerSelector.file=null,this.bannerSelector.data="",this.$nextTick(()=>{this.$refs.bannerInput.value=""})},async submitBannerChange(e){if(this.bannerSelector.loading)return;this.$toast.loading("上传中..."),this.bannerSelector.loading=!0;const t=this.$utils.createFileName({userId:this.user.id,type:"banner",file:this.bannerSelector.file});try{await this.$store.dispatch("getUpToken"),e.append("token",this.user.uptoken.upToken),e.append("key",t);const r=await Object(S.g)(this,e);await Object(f.n)(this,{type:"banner",url:r.url}),this.$store.commit("SET_USER_INFO",{banner:`https://image.calibur.tv/${r.url}`}),this.$toast.success("背景更新成功")}catch(e){"string"==typeof e?this.$toast.error(e):this.$toast.error("背景更新失败，请刷新网页重试或选择其他图片")}finally{this.bannerSelector.loading=!1,this.cancelBannerSelect()}},bindUserPhone(){this.user.providers.bind_phone||(this.bindPhone.timeout?this.bindPhone.showInfoForm=!0:this.$prompt("请输入要绑定的手机号（11位）","绑定手机",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^(0|86|17951)?(1)[0-9]{10}$/,inputErrorMessage:"请输入正确的手机号码"}).then(({value:e})=>{this.bindPhone.phone=e,this.$captcha({success:async({data:data})=>{try{await Object(f.m)(this,{type:"bind_phone",phone_number:e,geetest:data}),this.bindPhone.showInfoForm=!0}finally{this.bindPhone.timeout=60;const e=setInterval(()=>{--this.bindPhone.timeout||clearInterval(e)},1e3)}}})}).catch(()=>{}))},async submitBindPhone(){if(!this.user.providers.bind_phone){if(6!==this.bindPhone.authCode.length)return this.$toast.error("请输入正确的短信验证码");if(this.bindPhone.password.length<6)return this.$toast.error("密码不能小于6位");if(this.bindPhone.password.length>16)return this.$toast.error("密码不能大于16位");if(!this.bindPhone.loadingBindPhone){this.bindPhone.loadingBindPhone=!0;try{await Object(f.a)(this,{id:this.user.id,phone:this.bindPhone.phone,password:this.bindPhone.password,authCode:this.bindPhone.authCode}),this.$toast.success("手机号绑定成功").then(()=>{this.bindPhone.showInfoForm=!1,window.location.reload()})}finally{this.bindPhone.loadingBindPhone=!1}}}}}};var k=Object(c.a)(x,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"user-setting"}},[e._ssrNode('<div class="form-item">',"</div>",[e._ssrNode('<p class="sub-title">\n      背景：\n    </p> '),e._ssrNode('<div class="banner-setting"'+e._ssrStyle(null,{backgroundImage:"url("+e.$resize(e.user.banner,{height:120,mode:2})+")"},null)+">","</div>",[e.bannerSelector.data?[r("image-cropper",{attrs:{"init-image":e.bannerSelector.data,uploading:e.bannerSelector.loading,"auto-size":!0},on:{submit:e.submitBannerChange}}),e._ssrNode(" "),r("el-button",{staticClass:"cancel-btn",attrs:{disabled:e.bannerSelector.loading,size:"mini",type:"info",round:""},on:{click:e.cancelBannerSelect}},[e._v("\n          取消\n        ")])]:e._ssrNode('<div class="submit-banner-btn file-input">\n        点击更新背景\n        <input type="file" accept="image/png, image/jpeg, image/jpg, image/x-png, image/gif" name="file"></div>')],2)],2),e._ssrNode(' <div class="hr"></div> '),e._ssrNode('<div class="form-item">',"</div>",[e._ssrNode('<p class="sub-title">\n      头像：\n    </p> '),e._ssrNode('<div class="container avatar-setting">',"</div>",[r("v-drawer",{attrs:{"header-text":"头像裁剪",from:"bottom",size:"450px"},on:{cancel:e.cancelAvatarSelect},model:{value:e.avatarSelector.showDrawer,callback:function(t){e.$set(e.avatarSelector,"showDrawer",t)},expression:"avatarSelector.showDrawer"}},[e.avatarSelector.showDrawer?r("image-cropper",{attrs:{"init-image":e.avatarSelector.data,uploading:e.avatarSelector.loading,width:300,height:300,type:"avatar"},on:{submit:e.submitAvatarChange}}):e._e()],1),e._ssrNode(' <div class="avatar"'+e._ssrStyle(null,{backgroundImage:"url("+e.$resize(e.user.avatar,{width:80})+")"},null)+'></div> <div class="change-image-btn file-input">\n        点击更新头像\n        <input type="file" accept="image/png, image/jpeg, image/jpg, image/x-png, image/gif" name="file"></div>')],2)],2),e._ssrNode(' <div class="hr"></div> <div class="hr"></div> <div class="form-item"><p class="sub-title">\n      绑定：\n    </p> <div class="providers"><a'+e._ssrAttr("href","https://api.calibur.tv/callback/oauth2/qq?from=bind&id="+e.user.id+"&zone="+e.user.zone)+"><i"+e._ssrClass("iconfont icon-qq",{"is-bind":e.user.providers.bind_qq})+"></i></a> <a"+e._ssrAttr("href",e.ua.wechat?"https://api.calibur.tv/callback/oauth2/weixin?from=bind&id="+e.user.id+"&zone="+e.user.zone:"javascript:;")+"><i"+e._ssrClass("iconfont icon-wechat",{"is-bind":e.user.providers.bind_wechat})+'></i></a> <a href="javascript:;"><i'+e._ssrClass("iconfont icon-phone",{"is-bind":e.user.providers.bind_phone})+'></i></a></div></div> <div class="hr"></div> '),e._ssrNode('<div class="form-item">',"</div>",[e._ssrNode('<p class="sub-title">\n      其它：\n    </p> '),e._ssrNode('<div class="container">',"</div>",[r("user-setting-form")],1)],2),e._ssrNode(" "),r("v-drawer",{attrs:{from:"bottom","header-text":"填写信息","submit-text":"确认"},on:{submit:e.submitBindPhone},model:{value:e.bindPhone.showInfoForm,callback:function(t){e.$set(e.bindPhone,"showInfoForm",t)},expression:"bindPhone.showInfoForm"}},[r("div",{staticClass:"container"},[r("el-input",{attrs:{type:"number",placeholder:"短信验证码","auto-complete":"off"},model:{value:e.bindPhone.authCode,callback:function(t){e.$set(e.bindPhone,"authCode","string"==typeof t?t.trim():t)},expression:"bindPhone.authCode"}}),e._v(" "),r("br"),e._v(" "),r("br"),e._v(" "),r("el-input",{attrs:{type:"text",placeholder:"密码（6-16个字符组成，区分大小写）","auto-complete":"off"},model:{value:e.bindPhone.password,callback:function(t){e.$set(e.bindPhone,"password","string"==typeof t?t.trim():t)},expression:"bindPhone.password"}})],1)])],2)},[],!1,function(e){var t=r(377);t.__inject__&&t.__inject__(e)},null,"97721cde");t.default=k.exports}};
//# sourceMappingURL=setting.chunk.bf06da60.js.map